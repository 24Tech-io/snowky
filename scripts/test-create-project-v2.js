// Node 18+ has native fetch

async function testProjectCreation() {
    const baseUrl = 'http://localhost:3000';
    const timestamp = Date.now();
    const email = `testuser_${timestamp}@test.com`;
    const password = 'password123';

    console.log("=== STARTING VERIFICATION ===");

    // 0. Register (optional, ignore if exists)
    console.log("0. Attempting registration (if user missing)...");
    try {
        const regRes = await fetch(`${baseUrl}/api/auth/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email,
                password,
                name: "Test User"
            })
        });
        if (regRes.ok) console.log("-> Registration successful");
        else console.log("-> Registration response:", await regRes.text());
    } catch (e) { console.log("-> Register skipped/error (likely exists)", e.message); }

    // 1. Login
    console.log("1. Logging in...");
    const loginRes = await fetch(`${baseUrl}/api/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
    });

    if (!loginRes.ok) {
        console.error("-> Login failed:", await loginRes.text());
        return;
    }

    const cookie = loginRes.headers.get('set-cookie');
    console.log("-> Login successful. Cookie obtained.");

    // 2. Create Project
    console.log("2. Creating Project with 'botName' and 'showFloatingLauncher'...");
    const createRes = await fetch(`${baseUrl}/api/projects`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Cookie': cookie
        },
        body: JSON.stringify({
            name: "Test Project " + Date.now(),
            description: "Generated by verification script",
            botName: "TestBot",
            welcomeMessage: "Hi testing!",
            showFloatingLauncher: false // Test our new field too
        })
    });

    if (createRes.ok) {
        const data = await createRes.json();
        console.log("-> Project created WITHOUT ERROR!", JSON.stringify(data, null, 2));
        console.log("=== SUCCESS: Schema and API are working correctly ===");
    } else {
        const text = await createRes.text();
        console.error("-> Project creation FAILED:", text);
        if (text.includes("Unknown argument")) {
            console.log(">>> CONFIRMED: Server restart required for Prisma Client update.");
        }
    }
}

testProjectCreation();
